<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Mini Fight (Punch & Kick)</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", sans-serif; background:#111; color:#fff; touch-action:none; }
  #ui { position:fixed; top:0; left:0; right:0; padding:10px; display:flex; gap:10px; align-items:center; z-index:10; background:linear-gradient(#111, rgba(17,17,17,.2)); }
  .bar { flex:1; height:14px; background:#333; border-radius:999px; overflow:hidden; }
  .bar > div { height:100%; width:100%; transition: width .08s linear, background .2s; }
  #msg { min-width:10em; text-align:center; font-weight:900; letter-spacing:.5px; }

  #arena { position:fixed; left:0; right:0; top:44px; bottom:140px; background:radial-gradient(circle at 50% 20%, #222, #0b0b0b 65%); overflow:hidden; }
  #ground { position:absolute; left:0; right:0; bottom:0; height:18px; background:#1f1f1f; box-shadow: 0 -1px 0 rgba(255,255,255,.05) inset; }

  .fighter{
    position:absolute; bottom:18px;
    width:64px; height:96px;
    border-radius:14px;
    box-shadow: 0 10px 25px rgba(0,0,0,.35);
    user-select:none;
    will-change:left, bottom, transform;
  }
  #p1 { background:#3498db; }
  #cpu { background:#e74c3c; transform: scaleX(-1); }

  .name { position:absolute; top:-22px; left:0; right:0; text-align:center; font-size:12px; opacity:.9; font-weight:700; }
  .face { position:absolute; left:12px; right:12px; bottom:14px; height:36px; border-radius:999px; background:rgba(255,255,255,.12); }

  /* „Éí„ÉÉ„Éà„Éú„ÉÉ„ÇØ„ÇπÔºöÊîªÊíÉ„ÅÆÁ®ÆÈ°û„Åß„Çµ„Ç§„Ç∫„ÅåÂ§â„Çè„Çã */
  .hitbox{
    position:absolute;
    bottom:26px;
    right:-10px;
    height:18px;
    border-radius:10px;
    opacity:0;
    pointer-events:none;
    transform: translateZ(0);
  }
  .show-hitbox { opacity:1; }

  /* YOUÂÅ¥ÔºöPUNCH/KICK„ÅßÂπÖ„ÇíÂ§â„Åà„Çã */
  #p1.punching .hitbox{ width:40px; background:rgba(255,255,255,.28); opacity:1; }
  #p1.kicking  .hitbox{ width:72px; background:rgba(255,255,255,.18); opacity:1; }

  /* CPUÂÅ¥„ÇÇÂêåÊßòÔºàÂàÜ„Åã„Çä„ÇÑ„Åô„ÅïÁî®Ôºâ */
  #cpu.punching .hitbox{ width:40px; background:rgba(255,255,255,.28); opacity:1; }
  #cpu.kicking  .hitbox{ width:72px; background:rgba(255,255,255,.18); opacity:1; }

  #controls{
    position:fixed; left:0; right:0; bottom:0; height:140px;
    display:flex; gap:12px; padding:12px;
    background:linear-gradient(rgba(17,17,17,.2), #111);
    z-index:10;
  }
  .pad { flex:1; display:flex; gap:12px; }
  button{
    flex:1;
    border:0; border-radius:18px;
    background:#2a2a2a; color:#fff;
    font-size:18px; font-weight:900;
    box-shadow: 0 10px 18px rgba(0,0,0,.35);
    -webkit-tap-highlight-color: transparent;
  }
  button:active{ transform: translateY(1px); filter:brightness(1.1); }
  #jump { background:#9b59b6; }
  #punch { background:#f1c40f; color:#111; }
  #kick { background:#e67e22; }
  #restart { max-width:120px; }
  .tiny { font-size:12px; opacity:.85; font-weight:650; }
</style>
</head>
<body>
  <div id="ui">
    <div class="bar"><div id="hp1"></div></div>
    <div id="msg">FIGHT!</div>
    <div class="bar"><div id="hp2"></div></div>
  </div>

  <div id="arena">
    <div id="p1" class="fighter">
      <div class="name">YOU</div>
      <div class="face"></div>
      <div class="hitbox"></div>
    </div>
    <div id="cpu" class="fighter">
      <div class="name">CPU</div>
      <div class="face"></div>
      <div class="hitbox"></div>
    </div>
    <div id="ground"></div>
  </div>

  <div id="controls">
    <div class="pad">
      <button id="left">‚Üê<div class="tiny">ÁßªÂãï</div></button>
      <button id="right">‚Üí<div class="tiny">ÁßªÂãï</div></button>
    </div>

    <button id="jump">‚¨ÜÔ∏è<div class="tiny">„Ç∏„É£„É≥„Éó</div></button>
    <button id="punch">üëä<div class="tiny">Âº±P</div></button>
    <button id="kick">ü¶µ<div class="tiny">Âº∑K</div></button>

    <button id="restart">‚Üª<div class="tiny">ÂÜçÈñã</div></button>
  </div>

<script>
(() => {
  // ======= Ë™øÊï¥„Éù„Ç§„É≥„Éà =======
  const MAX_HP = 100;
  const MOVE_SPEED = 5;

  // „Ç∏„É£„É≥„Éó
  const JUMP_V = 14;
  const GRAVITY = 0.75;
  const LAND_LAG_MS = 150;

  // CPU
  const CPU_THINK_MS = 160;

  // ÊîªÊíÉ2Á®ÆÔºöÂ∑Æ„Åå‚ÄúË¶ã„Åà„Çã‚Äù„Çà„ÅÜ„Å´ÔºàÂ∞ÑÁ®ã/Èöô/„ÉÄ„É°Ôºâ
  const ATTACKS = {
    punch: { label:'PUNCH', dmg: 7,  range: 52, activeMs: 90,  recoveryMs: 140, cooldownMs: 220, push: 8 },
    kick:  { label:'KICK',  dmg: 13, range: 78, activeMs: 130, recoveryMs: 260, cooldownMs: 420, push: 12 }
  };
  // ============================

  const arena = document.getElementById('arena');
  const p1El = document.getElementById('p1');
  const cpuEl = document.getElementById('cpu');
  const hp1El = document.getElementById('hp1');
  const hp2El = document.getElementById('hp2');
  const msgEl = document.getElementById('msg');

  const btnL = document.getElementById('left');
  const btnR = document.getElementById('right');
  const btnJ = document.getElementById('jump');
  const btnP = document.getElementById('punch');
  const btnK = document.getElementById('kick');
  const btnRe = document.getElementById('restart');

  const state = {
    running: true,
    p1: { x:0, y:0, vy:0, lockUntil:0, hp:MAX_HP, lastAtkAt:{punch:0,kick:0} },
    cpu:{ x:0, hp:MAX_HP, lastAtkAt:{punch:0,kick:0} },
    input:{ left:false, right:false },
    lastCpuThink: 0
  };

  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const nowMs = ()=>performance.now();
  const setMsg = (t)=>{ msgEl.textContent = t; };

  function hpColor(hp){
    const r = hp / MAX_HP;
    if (r > 0.6) return '#2ecc71';
    if (r > 0.3) return '#f1c40f';
    return '#e74c3c';
  }

  function distance(){
    return Math.abs((state.p1.x + 32) - (state.cpu.x + 32));
  }

  function layoutInit(){
    const w = arena.clientWidth;
    state.p1.x = w * 0.20;
    state.cpu.x = w * 0.70;
    render();
  }

  function render(){
    p1El.style.left = `${state.p1.x}px`;
    cpuEl.style.left = `${state.cpu.x}px`;

    p1El.style.bottom = `${18 + state.p1.y}px`;
    cpuEl.style.bottom = `18px`;

    hp1El.style.width = `${(state.p1.hp / MAX_HP) * 100}%`;
    hp2El.style.width = `${(state.cpu.hp / MAX_HP) * 100}%`;
    hp1El.style.background = hpColor(state.p1.hp);
    hp2El.style.background = hpColor(state.cpu.hp);
  }

  function endIfDead(){
    if (state.p1.hp <= 0) { state.running = false; setMsg('CPU WIN!'); return true; }
    if (state.cpu.hp <= 0){ state.running = false; setMsg('YOU WIN!'); return true; }
    return false;
  }

  // ÂÆâÂÆö„Çø„ÉÉ„ÉóÔºà„Çπ„Éû„ÉõÂØæÁ≠ñÔºâ
  function bindTap(btn, fn){
    const handler = (e) => { e.preventDefault?.(); fn(); };
    btn.addEventListener('pointerdown', handler, { passive:false });
    btn.addEventListener('touchstart', handler, { passive:false });
    btn.addEventListener('mousedown', handler);
    btn.addEventListener('click', (e)=>{ e.preventDefault(); fn(); });
  }

  // Êäº„Åó„Å£„Å±ÁßªÂãï
  function bindHold(btn, key){
    const on  = (e)=>{ e.preventDefault?.(); state.input[key]=true; };
    const off = (e)=>{ e.preventDefault?.(); state.input[key]=false; };
    btn.addEventListener('pointerdown', on, { passive:false });
    btn.addEventListener('touchstart', on, { passive:false });
    btn.addEventListener('mousedown', on);
    btn.addEventListener('pointerup', off);
    btn.addEventListener('pointercancel', off);
    btn.addEventListener('pointerleave', off);
    btn.addEventListener('touchend', off);
    btn.addEventListener('touchcancel', off);
    btn.addEventListener('mouseup', off);
    btn.addEventListener('mouseleave', off);
  }

  function setP1Lock(t, ms){
    state.p1.lockUntil = Math.max(state.p1.lockUntil, t + ms);
  }

  function canUseAttack(who, type, t){
    return (t - who.lastAtkAt[type]) >= ATTACKS[type].cooldownMs;
  }

  function showAttackAnim(el, type, ms){
    el.classList.remove('punching','kicking');
    el.classList.add(type === 'punch' ? 'punching' : 'kicking');
    setTimeout(()=>el.classList.remove('punching','kicking'), ms);
  }

  function doJump(){
    const t = nowMs();
    if (!state.running) return;
    if (t < state.p1.lockUntil) return;
    if (state.p1.y === 0) {
      state.p1.vy = JUMP_V;
      setMsg('JUMP!');
    }
  }

  function doAttackP1(type){
    const t = nowMs();
    if (!state.running) return;

    if (state.p1.y > 0) { setMsg('AIR'); return; }
    if (t < state.p1.lockUntil) return;
    if (!canUseAttack(state.p1, type, t)) return;

    const spec = ATTACKS[type];
    state.p1.lastAtkAt[type] = t;

    // Ë¶ã„ÅüÁõÆ
    showAttackAnim(p1El, type, spec.activeMs);

    // Á°¨Áõ¥ÔºàÈöôÔºâ
    setP1Lock(t, spec.recoveryMs);

    // Âà§ÂÆö
    if (distance() <= spec.range) {
      state.cpu.hp = clamp(state.cpu.hp - spec.dmg, 0, MAX_HP);
      setMsg(`${spec.label}! HIT`);
      state.cpu.x = clamp(state.cpu.x + (-spec.push), 0, arena.clientWidth - 64);
    } else {
      setMsg(`${spec.label}! MISS`);
    }

    endIfDead();
    render();
  }

  function doAttackCPU(type){
    const t = nowMs();
    if (!state.running) return;
    if (!canUseAttack(state.cpu, type, t)) return;

    const spec = ATTACKS[type];
    state.cpu.lastAtkAt[type] = t;

    showAttackAnim(cpuEl, type, spec.activeMs);

    if (distance() <= spec.range) {
      state.p1.hp = clamp(state.p1.hp - spec.dmg, 0, MAX_HP);
      setMsg(`CPU ${spec.label}!`);
      state.p1.x = clamp(state.p1.x + (spec.push), 0, arena.clientWidth - 64);
      setP1Lock(t, 90);
    } else {
      setMsg(`CPU ${spec.label} MISS`);
    }

    endIfDead();
    render();
  }

  function cpuThink(){
    const d = distance();
    const toward = (state.p1.x > state.cpu.x) ? 1 : -1;

    if (d > 95) {
      state.cpu.x += toward * MOVE_SPEED * 0.85;
    } else {
      const r = Math.random();
      if (d <= ATTACKS.kick.range && r < 0.55) doAttackCPU('kick');
      else doAttackCPU('punch');

      if (Math.random() < 0.25) state.cpu.x -= toward * MOVE_SPEED * 0.7;
    }

    state.cpu.x = clamp(state.cpu.x, 0, arena.clientWidth - 64);
  }

  function reset(){
    state.running = true;
    state.p1.hp = MAX_HP;
    state.cpu.hp = MAX_HP;

    state.p1.y = 0;
    state.p1.vy = 0;
    state.p1.lockUntil = 0;

    state.p1.lastAtkAt.punch = 0;
    state.p1.lastAtkAt.kick = 0;
    state.cpu.lastAtkAt.punch = 0;
    state.cpu.lastAtkAt.kick = 0;

    state.input.left = false;
    state.input.right = false;

    setMsg('FIGHT!');
    layoutInit();
  }

  // ÂÖ•Âäõ„Éê„Ç§„É≥„Éâ
  bindHold(btnL, 'left');
  bindHold(btnR, 'right');
  bindTap(btnJ, () => doJump());
  bindTap(btnP, () => doAttackP1('punch'));
  bindTap(btnK, () => doAttackP1('kick'));
  bindTap(btnRe, () => reset());

  // „É°„Ç§„É≥„É´„Éº„Éó
  function tick(t){
    if (state.running) {
      // „Ç∏„É£„É≥„ÉóÁâ©ÁêÜ
      if (state.p1.y > 0 || state.p1.vy > 0) {
        state.p1.y += state.p1.vy;
        state.p1.vy -= GRAVITY;
        if (state.p1.y <= 0) {
          state.p1.y = 0;
          state.p1.vy = 0;
          setP1Lock(t, LAND_LAG_MS);
          setMsg('LAND');
        }
      }

      // ÁßªÂãïÔºàÁ°¨Áõ¥‰∏≠„ÅØ‰∏çÂèØÔºâ
      if (t >= state.p1.lockUntil) {
        if (state.input.left)  state.p1.x -= MOVE_SPEED;
        if (state.input.right) state.p1.x += MOVE_SPEED;
      }
      state.p1.x = clamp(state.p1.x, 0, arena.clientWidth - 64);

      // CPU
      if (t - state.lastCpuThink > CPU_THINK_MS) {
        state.lastCpuThink = t;
        cpuThink();
      }
    }

    render();
    requestAnimationFrame(tick);
  }

  window.addEventListener('resize', layoutInit);
  layoutInit();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
